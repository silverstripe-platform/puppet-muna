<?php
# Managed by Puppet
define('WEBROOT_PATH', '<%= @webroot_path %>');
define('SSL_PATH', '<%= @ssl_path %>');
define('NAMESPACE_CONFIG_PATH', '/opt/muna/conf/namespaces.ini');
define('SSL_CONFIG_PATH', '/opt/muna/conf/ssl_%s.ini');

function output($message) {
    echo $message.PHP_EOL;
}

function quit($message, $code = 0) {
    output($message);
    exit($code);
}

function get_region_v2() {
    $ch = curl_init();

    // Get metadata V2
    $headers = array (
            'X-aws-ec2-metadata-token-ttl-seconds: 10' );
    $url = "http://169.254.169.254/latest/api/token";
    curl_setopt( $ch, CURLOPT_URL, $url );
    curl_setopt( $ch, CURLOPT_HTTPHEADER, $headers );
    curl_setopt( $ch, CURLOPT_RETURNTRANSFER, true );
    curl_setopt( $ch, CURLOPT_CUSTOMREQUEST, "PUT" );
    curl_setopt( $ch, CURLOPT_URL, $url );
    $token = curl_exec( $ch );

    // Get region from metadata 
    $headers = array (
            'X-aws-ec2-metadata-token: '.$token );
    $url = "http://169.254.169.254/latest/meta-data/placement/region";

    curl_setopt( $ch, CURLOPT_URL, $url );
    curl_setopt( $ch, CURLOPT_HTTPHEADER, $headers );
    curl_setopt( $ch, CURLOPT_RETURNTRANSFER, true );
    curl_setopt( $ch, CURLOPT_CUSTOMREQUEST, "GET" );
    $result = curl_exec( $ch );

    return $result;
}

<% if @http_proxy %>
putenv('http_proxy=<%= @http_proxy %>');
putenv('HTTP_PROXY=<%= @http_proxy %>');
<% end %>
<% if @https_proxy %>
putenv('https_proxy=<%= @https_proxy %>');
putenv('HTTPS_PROXY=<%= @https_proxy %>');
<% end %>
<% if @aws_key %>putenv('AWS_ACCESS_KEY_ID=<%= @aws_key %>');<% end %>
<% if @aws_secret %>putenv('AWS_SECRET_ACCESS_KEY=<%= @aws_secret %>');<% end %>
<% if @aws_region %>
putenv('AWS_REGION=<%= @aws_region %>');
<% else %>
if (!empty($argv[2])) {
	// Muna will not automatically pick this up from the PHP process
	putenv('AWS_REGION='.$argv[2]);
}
<% end %>

